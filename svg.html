<html>
  <head>
    <title>SVG hack</title>
    <link rel="stylesheet" href="https://use.typekit.net/srk3hpl.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.16/svg.min.js" integrity="sha512-p3Tp2zn+wApBreZCgRkmMwnfpN8MUPXzzOihXx7iGYXqE7t6m9drY8HeyMeeFuDWiTFKrGUrq3jpbT0vX6zY/Q==" crossorigin="anonymous"></script>
    <script src="svgcard.js"></script>
  </head>
  <body>
    <script>
      const weapon = {
            name: 'Sword',
            usage: 3,
            damage: 'd6/d8',
            armour: false,
            mechanicDetail: '',
            clearDetail: '',
            classDetail: 'Medium',
            image: 'Sword',
            imageSource: new URL('item-light-1.png', document.baseURI).href,
            backgroundColor: '#ffffff',
            foregroundColor: '#000000',
            width: 1,
            height: 1,
            divider: true,
            border: true,
            star: false,
        };
      const armour = {
            name: 'Heavy armour',
            usage: 3,
            damage: '1 def',
            armour: true,
            mechanicDetail: '',
            clearDetail: '',
            classDetail: 'Heavy',
            image: 'Heavy armour',
            imageSource: new URL('item-heavy-armour.png', document.baseURI).href,
            backgroundImage: 'paper.jpg',
            backgroundColor: '#bdb3a8',
            foregroundColor: '#000000',
            width: 1,
            height: 2,
            divider: true,
            border: true,
            star: false,
        };
      const spell = {
            name: 'Restore',
            usage: 3,
            damage: '',
            armour: false,
            mechanicDetail: '',
            clearDetail: '',
            classDetail: '',
            image: 'Spell 1',
            imageSource: new URL('spell-1.png', document.baseURI).href,
            backgroundColor: '#ffffff',
            foregroundColor: '#000000',
            width: 1,
            height: 1,
            divider: true,
            border: true,
            star: true,
        };
      const condition = {
            name: 'Injured',
            usage: 0,
            damage: '',
            armour: false,
            mechanicDetail: 'Disadvantage on STR and DEX saves',
            clearDetail: 'After full rest',
            classDetail: '',
            image: '',
            imageSource: '',
            backgroundColor: '#ff4444',
            foregroundColor: '#000000',
            width: 1,
            height: 1,
            divider: false,
            border: true,
            star: false,
        };
        const condition2 = {
            name: 'Frozen',
            usage: 6,
            damage: '',
            armour: false,
            mechanicDetail: 'You are frozen. Count turns in usage, dead when all used.',
            clearDetail: '',
            classDetail: '',
            image: '',
            imageSource: '',
            backgroundColor: '#384761',
            foregroundColor: '#ffffff',
            width: 1,
            height: 1,
            divider: true,
            border: false,
            star: false,
        };
        const razorclam = {
            name: 'Razor Clam',
            usage: 3,
            damage: 'd8',
            armour: false,
            mechanicDetail: 'Causes Irritated Injury on critical damage',
            clearDetail: '',
            classDetail: 'Heavy',
            image: 'razor',
            imageSource: new URL('razor_shell_8271_lg.png', document.baseURI).href,
            backgroundColor: 'white',
            foregroundColor: 'black',
            width: 1,
            height: 2,
            divider: true,
            border: true,
            star: false,
        };
        const limpet = {
            name: 'Limpet Shield',
            usage: 3,
            damage: '1/2 def',
            armour: true,
            mechanicDetail: '',
            clearDetail: '',
            classDetail: '',
            image: 'limpet',
            imageSource: new URL('limpet.png', document.baseURI).href,
            backgroundColor: 'white',
            foregroundColor: 'black',
            width: 1,
            height: 1,
            divider: true,
            border: true,
            star: false,
        };
        const irritated = {
            name: 'Irritated Injury',
            usage: 0,
            damage: '',
            armour: false,
            mechanicDetail: 'Disadvantage on STR and DEX saves',
            clearDetail: 'After two full rests',
            classDetail: '',
            image: '',
            imageSource: '',
            backgroundColor: '#cc5530',
            foregroundColor: '#000000',
            width: 1,
            height: 1,
            divider: false,
            border: true,
            star: false,
        };
      /*
       IDEAS
       - nudge image x/y
       - mechanics at bottom instead
       */
    renderItem(weapon);
    renderItem(armour);
    renderItem(spell);
    renderItem(condition);
    renderItem(condition2);
    renderItem(razorclam);

    function readFile(blob){
      return new Promise((resolve, reject) => {
        var fr = new FileReader();  
        fr.onload = () => {
          resolve(fr.result )
        };
        fr.readAsDataURL(blob);
      });
    }

    let item = renderItem(limpet);
    let link = document.createElement('a');
    link.innerText = "[prepare SVG]";
    link.download = 'item.svg';
    link.onclick = function() {
      let promises = [];
      /* Iterate through the images and replace URI references with embedded data: URLs */
      let svg = item.clone();
      for (let image of svg.find('image')) {
        p = fetch(image.attr('href')).then(function(response) {
          return response.blob();
        }).then(function(blob) {
          return readFile(blob);
        }).then(function(dataurl) {
          image.attr('href', dataurl, 'http://www.w3.org/1999/xlink');
        });
        promises.push(p);
      }
      /* When all those promises have finished, set the link to a data: of the SVG */
      Promise.all(promises).then(function() {
        let blob = new Blob([svg.svg()], {type:'image/svg+xml;charset=utf-8'});
        readFile(blob).then(function(dataurl) {
          link.href = dataurl;
          link.innerText = '[Download SVG]';
        });
      });
    };
    document.body.appendChild(link);
  </script>
  </body>
</html>
