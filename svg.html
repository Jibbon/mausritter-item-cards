<html>
  <head>
    <title>SVG hack</title>
    <link rel="stylesheet" href="https://use.typekit.net/srk3hpl.css">
    <style>
        .stroke { fill: white; stroke: black; stroke-width: 2px; }
        .usage { fill: white; stroke: black; stroke-width: 1.5px; }
        .header { fill: black; font: 20px ff-brokenscript-bc-web, serif; }
        text.damage {fill: black; font: bold 16px interstate-condensed, sans-serif; }
        .mechanics {fill: black; font: italic 14px interstate-condensed, sans-serif; }
        .clear {fill: black; font: 14px interstate-condensed, sans-serif; }
        .detail {fill: black; font: bold 15px interstate-condensed, sans-serif; }
        .star {fill: black;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
  </head>
  <body>
    <p>
    <img src="sample.png" height="320"/>
    </p>
    <script>
    function makeStar(draw, spikes, outer, inner) {
      var points = [];
      const degrees = 360/spikes;
      for (i = 0; i < spikes; i++) {
        a = i * degrees + 90
        x = outer + inner * Math.cos(a * Math.PI / 180)
        y = outer + inner * Math.sin(a * Math.PI / 180)

        points.push([x, y])

        a += degrees / 2
        x = outer + outer * Math.cos(a * Math.PI / 180)
        y = outer + outer * Math.sin(a * Math.PI / 180)

        points.push([x, y])
      }
      return draw.polyline(points);
    }

    function wrapText(text, maxWidth, string) {
      const words = string.split(/\s+/);
      var span = text.tspan('');
      let line = ''
      for(var n = 0; n < words.length; n++) {
        span.text(line + words[n] + " ");
        if (span.length() > maxWidth && n > 0) {
          span.text(line);
          span.newLine();
          span = text.tspan(words[n] + '');
          line = words[n] + " ";
        } else {
          line = span.text()
        }
      }
      span.newLine();
    }

    function renderItem(item) {
      var draw = SVG().addTo('body').size(150 * item.width, 150 * item.height);
      // TODO draw.css should work?
      //draw.style(".header", {fill: "black", font: "20px ff-brokenscript-bc-web, serif"});

      var d = draw.rect(draw.width()-2, draw.height()-2).move(1, 1).css("fill", item.backgroundColor);
      if (item.border) d.addClass("stroke");

      if (item.divider) draw.line(1, 35, draw.width()-2, 35).addClass("stroke");

      if (item.star) makeStar(draw, 5, 11, 5).center(17, 35/2).addClass("star");

      if (item.name.length) {
        draw.plain(item.name).move(item.star ? 32 : 8, 11).addClass("header");
      }

      for (let i = 0; i < item.usage; i++) {
        const x = 8 + (i % 3) * 18;
        const y = 45 + Math.floor(i / 3) * 18;
        draw.circle(15).move(x, y).addClass("usage");
      }

      if (item.damage.length) {
        group = draw.group();
        let bbox = group.plain(item.damage).addClass("damage").bbox();
        bbox.x -= 5;
        bbox.y -= 5;
        bbox.width += 10;
        bbox.height += 10;
        group.rect(bbox.width, bbox.height).move(bbox.x, bbox.y).addClass("stroke").backward();
        group.move(draw.width() - 8 - bbox.width, 35+8);
      }

      if (item.classDetail.length) {
        draw.plain(item.classDetail).move(8, draw.height() - 8-17).addClass("detail");
      }

      if (item.mechanicDetail.length) {
        var text = draw.text(function(t) {
          t.addClass("mechanics");
          t.leading('1.2em');
          wrapText(t, 150 - 8 - 8, item.mechanicDetail);
        }).move(8, 32);
      }

      if (item.clearDetail.length) {
        var text = draw.text(function(t) {
          t.addClass("clear");
          t.leading('1.2em');
          t.tspan('Clear:').font('weight', 'bold').newLine();
          wrapText(t, 150 - 8 - 8, item.clearDetail);
        });
        text.move(8, 150 - 8 - text.bbox().height);
      }
    }
    </script>
    <script>
      const weapon = {
            name: 'Sword',
            usage: 3,
            damage: 'd6/d8',
            mechanicDetail: '',
            clearDetail: '',
            classDetail: 'Medium',
            image: 'Sword',
            backgroundColor: '#ffffff',
            foregroundColor: '#000000',
            width: 1,
            height: 1,
            divider: true,
            border: true,
            star: false,
        };
      const armour = {
            name: 'Heavy armour',
            usage: 3,
            damage: '1 def',
            mechanicDetail: '',
            clearDetail: '',
            classDetail: 'Heavy',
            image: 'Heavy armour',
            backgroundColor: '#ffffff',
            foregroundColor: '#000000',
            width: 1,
            height: 2,
            divider: true,
            border: true,
            star: false,
        };
      const spell = {
            name: 'Restore',
            usage: 3,
            damage: '',
            mechanicDetail: '',
            clearDetail: '',
            classDetail: '',
            image: 'Spell 1',
            backgroundColor: '#ffffff',
            foregroundColor: '#000000',
            width: 1,
            height: 1,
            divider: true,
            border: true,
            star: true,
        };
      const condition = {
            name: 'Injured',
            usage: 0,
            damage: '',
            mechanicDetail: 'Disadvantage on STR and DEX saves',
            clearDetail: 'After full rest',
            classDetail: '',
            image: '',
            backgroundColor: '#ff4444',
            foregroundColor: '#000000',
            width: 1,
            height: 1,
            divider: false,
            border: true,
            star: false,
        };
    renderItem(weapon);
    renderItem(armour);
    renderItem(spell);
    renderItem(condition);
    </script>
  </body>
</html>
