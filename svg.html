<html>
  <head>
    <title>SVG hack</title>
    <link rel="stylesheet" href="https://use.typekit.net/srk3hpl.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.0.16/svg.min.js" integrity="sha512-p3Tp2zn+wApBreZCgRkmMwnfpN8MUPXzzOihXx7iGYXqE7t6m9drY8HeyMeeFuDWiTFKrGUrq3jpbT0vX6zY/Q==" crossorigin="anonymous"></script>
    <script src="svgcard.js"></script>
    <script src="templates.js"></script>
  </head>

  <body>
    <section class="section">
      <div class="field">
        <label class="label">Template</label>
        <div class="select">
          <select id="itemselect" oninput="updateTemplate();"></select>
        </div>
      </div>

      <div class="card">
        <div id="display" class="card-content"></div>
        <footer class="card-footer">
          <a href="#" class="card-footer-item" id="svglink" onclick="downloadsvg();">Download SVG</a>
        </footer>
      </div>
    </section>

    <script>
      /*
       IDEAS
       - mechanics at bottom instead
       */

    let item = undefined;

    function readFile(blob){
      return new Promise((resolve, reject) => {
        var fr = new FileReader();
        fr.onload = () => {
          resolve(fr.result )
        };
        fr.readAsDataURL(blob);
      });
    }

    function generatesvg(selector) {
      let promises = [];
      /* Iterate through the images and replace URI references with embedded data: URLs */
      let svg = SVG(selector).clone();
      for (let image of svg.find('image')) {
        p = fetch(image.attr('href')).then(function(response) {
          return response.blob();
        }).then(function(blob) {
          return readFile(blob);
        }).then(function(dataurl) {
          image.attr('href', dataurl, 'http://www.w3.org/1999/xlink');
        });
        promises.push(p);
      }
      /* When all those promises have finished, turn the SVG to a data URL and chain */
      return Promise.all(promises).then(function() {
        let blob = new Blob([svg.svg()], {type:'image/svg+xml;charset=utf-8'});
        return readFile(blob);
      });
    }

    /* Download the SVG */
    function downloadsvg() {
      generatesvg('#display svg').then(function(dataurl) {
        let a = document.createElement('a');
        // TODO: somehow use item.name + ".svg"
        a.download = 'item.svg'
        a.href = dataurl;
        a.click();
      });
    }

    const itemselect = document.getElementById('itemselect');

    function populateSelect() {
      for (const key in itemTemplates) {
        let opt = document.createElement("option");
        opt.value = key;
        opt.text = itemTemplates[key].name;
        itemselect.add(opt, null);
      }
      updateTemplate();
    }
    populateSelect();

    function removeAllChildren(element) {
      while (element.firstChild) {
        element.removeChild(element.firstChild)
      }
    }

    function updateTemplate() {
      item = Object.assign({}, itemTemplates[itemselect.value]);
      draw();
    }

    function draw() {
      removeAllChildren(document.getElementById('display'));
      let svg = renderItem(item, '#display');
    }
  </script>
  </body>
</html>
